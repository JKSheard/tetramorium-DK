---
title: "Niche modelling"
author: "Julie K. Sheard"
date: "15 okt 2019"
output: html_document
---

## Niche modelling

This is the script used to model the climatic niche of T. immigrans and T. caespitum in Europe. 

All climatic variables were downloaded from Worldclim 1.4 at 2.5 arc-minutes (~5 km) resolution (Hijmans et al., 2005). 

```{r}
#Required packages
library(raster)
library(ecospat)
library(dplyr)
library(ade4)
```

```{r}
#Load species data
setwd("//a00143.science.domain/lfj315/Documents/Projects/T immigrans/data")

spp <- read.csv("spp.csv",h=T,sep=";")
xy.sp1<-subset(spp,species=="sp1")[2:3] #Tetramorium_caespitum
xy.sp2<-subset(spp,species=="sp2")[2:3] #Tetramorium_immigrans

#Load and stack environmental data

setwd("//a00143.science.domain/lfj315/Documents/Projects/T immigrans/ArcGIS")

Bio01 <- raster("bio01.grd") #Mean annual temperature
Bio04 <- raster("bio04.grd") #Temperature seasonality
Bio10 <- raster("bio10.grd") #Temperature of warmest quarter
Bio11 <- raster("bio11.grd") #Temperature of coldest quarter
Bio12 <- raster("bio12.grd") #Annual precipitation
Bio15 <- raster("bio15.grd") #Precipitation seasonality
Bio16 <- raster("bio16.grd") #Precipitation of wettest quarter
Bio17 <- raster("bio17.grd") #Precipitation of driest quarter
Bio18 <- raster("bio18.grd") #Precipitation of warmest quarter
Bio19 <- raster("bio19.grd") #Precipitation of coldest quarter

env = stack(Bio01, Bio04, Bio10, Bio11, Bio12, Bio15, Bio16, Bio17, Bio18, Bio19)

plot(env) #Check
```

#Extract and re-label climate variables for each species

```{r}
env.sp1<-raster::extract(env,xy.sp1)
env.sp2<-raster::extract(env,xy.sp2)

#Exclude points with no data
env.sp1.1 <- na.omit(env.sp1)
env.sp2.2 <- na.omit(env.sp2)

colnames(env.sp1.1)
colnames(env.sp2.2)

colnames(env.sp1.1) <- c("Ann. mean. temp", "Temp. seasonality", "Warmest quarter temp.",
                       "Coldest quarter temp.", "Ann. precipitation", "Precipitation seasonality",
                       "Wettest quarter precip.", "Driest quarter precip.", "Warmest quarter precip.",
                       "Coldest quarter precip.")

colnames(env.sp2.2) <- c("Ann. mean. temp", "Temp. seasonality", "Warmest quarter temp.",
                       "Coldest quarter temp.", "Ann. precipitation", "Precipitation seasonality",
                       "Wettest quarter precip.", "Driest quarter precip.", "Warmest quarter precip.",
                       "Coldest quarter precip.")
```

#Extract and re-label climate variables for background environment

```{r}
env.bkg<-na.omit(values(env))

colnames(env.bkg)

colnames(env.bkg) <- c("Ann. mean. temp", "Temp. seasonality", "Warmest quarter temp.",
                       "Coldest quarter temp.", "Ann. precipitation", "Precipitation seasonality",
                       "Wettest quarter precip.", "Driest quarter precip.", "Warmest quarter precip.",
                        "Coldest quarter precip.")
```


#Run PCA and run niche equivalency and niche similarity tests

```{r}
pca.cal <- dudi.pca(env.bkg, center = TRUE, scale = TRUE, scannf = FALSE, nf = 2)

# predict the scores on the axes
scores.bkg <- pca.cal$li  #scores for background climate
scores.sp1 <- na.exclude(suprow(pca.cal,env.sp1)$lisup) #scores for sp1
scores.sp2 <- na.exclude(suprow(pca.cal,env.sp2)$lisup) #scores for sp2

# calculation of occurence density (niche z)
z1 <- ecospat.grid.clim.dyn(scores.bkg, scores.bkg, scores.sp1,R=100)
z2 <- ecospat.grid.clim.dyn(scores.bkg, scores.bkg, scores.sp2,R=100)

#Calculate niche overlap metrics D and I
ecospat.niche.overlap(z1,z2 ,cor=T)

#Run niche similarity test
sim.test <- ecospat.niche.similarity.test(z1, z2,
            rep=1000, alternative = "greater", rand.type=2)

#Run niche equivalency test
eq.test <- ecospat.niche.equivalency.test (z1, z2, 
           rep=1000, alternative = "greater", ncores = 1)

#Plot equivalency test
ecospat.plot.overlap.test(eq.test, "D", "Equivalency")
#Plot similarity test
ecospat.plot.overlap.test(sim.test, "D", "Similarity")
```

#Plot species climatic niche in seperate figures
```{r}
#Orange is T. caespitum and yellow is T. immigrans
ecospat.plot.niche.dyn(z1, z2, quant=0.25, interest=2,
                       title= "", name.axis1="PC1",
                       name.axis2="PC2", colZ1="black", colZ2="black",
                       colz2="#ffffbf", colz1="#fc8d59")

ecospat.shift.centroids(scores.sp1, scores.sp2, scores.bkg, scores.bkg,col="black")

```

#Conduct and plot PCA for both species combined
```{r}
#correlation circle
pca.env <- dudi.pca(rbind(env.sp1.1,env.sp2.2)[,1:9],scannf=F,nf=2)
dev.off()

#Plot variable contributions to PC1 and PC2
ecospat.plot.contrib(contrib=pca.env$co, eigen=pca.env$eig)

scores <- pca.env$li
```

#Plot species occurrence in geographic space
```{r}
par(mfrow=c(1,2))

#Tetramorium caespitum
geoz1<-ecospat.niche.zProjGeo(z1,env)
plot(geoz1,main="Tetramorium caespitum")
points(xy.sp1)

writeRaster(geoz1, filename="TetCae_geo_10.asc")

#Tetramorium immigrans
geoz2<-ecospat.niche.zProjGeo(z2,env)
plot(geoz2,main="Tetramorium immigrans")
points(xy.sp2)

writeRaster(geoz2, filename="TetImi_geo_10.asc")
```

#Create correlation circle for PCA
```{r}

pdf("PCA_contrib.pdf", height = 15, width = 15, useDingbats = FALSE)
ecospat.plot.contrib(pca.cal$co,pca.cal$eig)

dev.off()

unpack(ecospat.plot.contrib())
```